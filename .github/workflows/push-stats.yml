name: Estat칤sticas do Push (data, usu치rio e contagem de HTML/CSS/JS)

on:
  push:
    branches: [ "main" ]   # ajuste se sua branch padr칚o for outra
  workflow_dispatch:

jobs:
  push-stats:
    runs-on: ubuntu-latest

    steps:
      # 1) Precisamos do commit anterior para comparar
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Data/hora (UTC e local)
      - name: Data e hora
        id: data
        shell: bash
        run: |
          DT_UTC="$(date -u '+%d/%m/%Y %H:%M:%S UTC')"
          DT_LOCAL="$(date '+%d/%m/%Y %H:%M:%S %Z')"
          echo "Data/Hora (UTC):   $DT_UTC"
          echo "Data/Hora (Local): $DT_LOCAL"
          echo "dt_utc=$DT_UTC"     >> "$GITHUB_OUTPUT"
          echo "dt_local=$DT_LOCAL" >> "$GITHUB_OUTPUT"

      # 3) Usu치rio do push
      - name: Usu치rio do push
        id: usuario
        shell: bash
        run: |
          echo "Usu치rio (actor): $GITHUB_ACTOR"
          echo "actor=$GITHUB_ACTOR" >> "$GITHUB_OUTPUT"

      # 4) Arquivos alterados neste push (robusto, sem exit 1)
      - name: Arquivos alterados neste push
        id: changed
        shell: bash
        run: |
          set -u
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [[ -z "$BEFORE" || "$BEFORE" =~ ^0{40}$ ]]; then
            echo "Primeiro push ou 'before' inv치lido; listando arquivos rastreados."
            git ls-files > /tmp/changed_files.txt
          else
            echo "Comparando $BEFORE..$AFTER"
            git diff --name-only "$BEFORE" "$AFTER" > /tmp/changed_files.txt
          fi

          echo "Arquivos alterados:"
          cat /tmp/changed_files.txt || true

          # Contagens por extens칚o (case-insensitive) usando awk (n칚o falha quando n칚o h치 matches)
          COUNT_HTML=$(awk 'BEGIN{IGNORECASE=1} /\.html?$/ {c++} END{print c+0}' /tmp/changed_files.txt)
          COUNT_CSS=$(awk  'BEGIN{IGNORECASE=1} /\.css$/   {c++} END{print c+0}' /tmp/changed_files.txt)
          COUNT_JS=$(awk   'BEGIN{IGNORECASE=1} /\.m?js$/  {c++} END{print c+0}' /tmp/changed_files.txt)

          echo "HTML: $COUNT_HTML | CSS: $COUNT_CSS | JS: $COUNT_JS"

          echo "html=$COUNT_HTML" >> "$GITHUB_OUTPUT"
          echo "css=$COUNT_CSS"   >> "$GITHUB_OUTPUT"
          echo "js=$COUNT_JS"     >> "$GITHUB_OUTPUT"

      # 5) Resumo na aba Summary
      - name: Publicar resumo
        shell: bash
        run: |
          {
            echo "## 游늵 Estat칤sticas do Push"
            echo
            echo "- **Data/Hora (Local):** ${{ steps.data.outputs.dt_local }}"
            echo "- **Data/Hora (UTC):**   ${{ steps.data.outputs.dt_utc }}"
            echo "- **Usu치rio:**          ${{ steps.usuario.outputs.actor }}"
            echo
            echo "### Arquivos alterados neste push"
            echo "- **HTML:** ${{ steps.changed.outputs.html }}"
            echo "- **CSS:**  ${{ steps.changed.outputs.css }}"
            echo "- **JS:**   ${{ steps.changed.outputs.js }}"
          } >> "$GITHUB_STEP_SUMMARY"

      # 6) Logs diretos (opcional)
      - name: Mostrar no log em sequ칡ncia
        shell: bash
        run: |
          echo "游 ${ { steps.data.outputs.dt_local } }" | sed 's/{ //; s/ }//'
          echo "游녻 ${ { steps.usuario.outputs.actor } }" | sed 's/{ //; s/ }//'
          echo "游늯 HTML=${{ steps.changed.outputs.html }} CSS=${{ steps.changed.outputs.css }} JS=${{ steps.changed.outputs.js }}"

